<!doctype html>
<html lang="en-us">


<head>
    <meta charset="utf-8">
    <title>img2calc - cp.g3p</title>
</head>
    <style type="text/css"> 
        :root {
            --bg-body: #181a1b;     /* Fundo quase preto, mas suave */
            --bg-main: #222426;     /* Contentor principal */
            --bg-card: #2b2d30;     /* Cor das caixas (cards) */
            --text-color: #e6edf3;  /* Texto quase branco */
            --border-card: #3e444a; /* Bordas subtis */
            --button-bg: #373e47;   /* Botões cinza azulado */
            --button-hover-bg: #444c56;
            --link-color: #58a6ff;  /* Azul claro (igual à imagem) */
        }

        body {
            font-family:-apple-system,BlinkMacSystemFont,"Lucida Grande","Trebuchet MS",Verdana,Helvetica,Arial,sans-serif;
            text-align:center;
            margin:0;
            background-color: var(--bg-body); /* MODIFICAR */
            color: var(--text-color); /* MODIFICAR */
        }

        #mainContent {
            max-width:80%;
            margin:auto
        }

        .btn-ready {
            border: 2px solid orange !important;
            opacity: 1;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.8;
            border: 1px solid #ccc;
            cursor: not-allowed;
        }

        p { margin-top:0; }

        a { color: var(--link-color); text-decoration: none; }

        .button {
            display:inline-block;
            padding:10px;
            background:var(--button-bg);
            cursor:pointer;
            border-radius:5px;
            border:1px solid var(--button-bg); 
            color: var(--text-color); 
        }

        .button:hover {
            background:var(--button-hover-bg); 
        }


        #queueList, #fileList {
            list-style: none;
            padding-left: 0;
            margin-top: 5px;
            color: var(--text-color);
        }
    
        #fileList a {
            color: var(--text-color);
        }

        #fileElem, #folderElem {
            display:none
        }

        .half_div {
            width:49%;
            min-height:320px;
        }

        .rounded_div {
            border:1px dotted #bbb;
            border-radius:10px
        }

        #inFrame {
            float:left;
            left:0;
        }

        #outFrame {
            float:right;
            right:0;
        }

        #colorInput {
            width:8em;
        }

        #widthInput {
            width:3em;
        }

        #heightInput {
            width:3em;
        }

        #inImg {
            transition: transform .2s;
            image-rendering: pixelated;
        }

        #outImg {
            transition: transform .2s;
            image-rendering: pixelated;
        }

        .btn-group a { text-decoration: none }

        #queueList, #fileList {
            list-style: none;
            padding-left: 0;
            margin-top: 5px;
            color: var(--text-color);
        }

        #alertas {
            width: 100%;
            margin: 0 auto 15px auto;
            text-align: center;
            box-sizing: border-box;
            
            color: var(--text-color);
            border: 1px solid #6e2f2f;  /* Borda vermelha escura */
            border-radius: 6px;
            padding: 15px;
        }

        #alertas b {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color); /* Título num vermelho mais vivo */
        }

        #alertas .aviso { /* ou span, se usares o span */
            display: block;
            margin: 0;
            line-height: 1.5;
            font-size: 0.9em;
        }

    </style>

<script src='./utils/common.js'></script>
<script src='./utils/strings.js'></script>
<script src='./zlib/constants.js'></script>
<script src='./zlib/adler32.js'></script>
<script src='./zlib/zstream.js'></script>
<script src='./zlib/messages.js'></script>
<script src='./zlib/trees.js'></script> 
<script src='./zlib/deflate.js'></script>   
<script src='./deflate.js'></script>

<script>

    function getFit(w) {
        el = document.getElementById("fitInput");
        return el.checked;
    }
    function getRatio() {
        el = document.getElementById("ratioInput");
        return el.checked;
    }
    function getColors() {
        el = document.getElementById("colorInput");
        return el.value;
    }
    function getWidth() {
        el = document.getElementById("widthInput");
        return el.value;
    }
    function getHeight() {
        el = document.getElementById("heightInput");
        return el.value;
    }
    function setWidth(w) {
        el = document.getElementById("widthInput");
        el.value=w;
    }
    function setHeight(h) {
        el = document.getElementById("heightInput");
        el.value=h;
    }

    const params = new URLSearchParams(window.location.search);
    window.mode = 'var';
    window.target = 'cg';
    window.format = 'cp.g3p';
    window.calcsize = '';
</script>


<script type="module">
    import * as Magick from './wasm-imagemagick/magickApi.js';

    let global_inFileName = "";

    function handleInFile(file) {
        const fileReader = new FileReader();
        fileReader.onload = handleInFileData;
        fileReader.readAsDataURL(file);
        global_inFileName = file['name'];
    }

    function handleInFileData(file) {
        const inImg = new Image();
        inImg.src = file.target.result;
        inImg.onload = function () {
            handleInImg(inImg);
        };
    }

    function handleInImg(img) {
        const canvas = document.getElementById('inImgCanvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const context = canvas.getContext('2d', { willReadFrequently: true });
        context.drawImage(img, 0, 0);

        const imgData = context.getImageData(0, 0, img.width, img.height);
        const imgBuffer = imgData.data.buffer;  // ArrayBuffer
        const img_a = new Uint8Array(imgBuffer);
        window.transparent = false;
        for(let i=3; i<img_a.length; i+=4) {
           if(img_a[i]<255) {
               window.transparent = true;
               break;
           }
        }
        canvas.toBlob(handleInCanvas);
    }

    async function handleInCanvas(blob) {
        const sourceBytes = await blob.arrayBuffer();
        const localName = "input.png";
        let files = [{'name': localName, 'content': sourceBytes}];
        let command = ["convert", localName];
        let sizeparam;
        sizeparam = `${getWidth()}x${getHeight()}`;
        let sizeparam0 = sizeparam;
        if (!getRatio())
            sizeparam += '!';
        if (!getFit())
            sizeparam += '>';
        let sizeparams = [].concat(
            "-resize",
            sizeparam
        );
        if (!colorInput) {
        sizeparams = [].concat(
            sizeparams,
            "-extent",
            sizeparam0
        );
        }
        let colorparams = [].concat(
            "-colors",
            getColors()
        );
        command = [].concat(command, ["-background", "white", "-flatten"], sizeparams, colorparams);
        command.push("out.png");
        
// console.log(command);
        const processedFiles = await Magick.Call(files, command);
        const firstOutputImg = processedFiles[0];
        const inImg = document.getElementById("inImg");
        inImg.src = URL.createObjectURL(blob);
        inImg.style.maxWidth = `${getWidth()}px`;
        inImg.style.maxHeight = `${getHeight()}px`;
        const outImg = new Image();
        outImg.onload = function () {
            handleOutImg(outImg);
        };
        outImg.src = URL.createObjectURL(firstOutputImg['blob']);
    }


    function getPixel_RGBA_int(img, i, r, g, b, a) {
        i *= 4;
        return img[i + 2] >> (8 - r) | img[i + 1] >> (8 - g) << r | img[i] >> (8 - b) << (r + g) | img[i + 3] >> (8 - a) << (r + g + b);
    }


// known CP formats
// CP.g3p + 0-1 footer : Casio provided (zlib ID 0x789C obfuscated as 0x3C1B) - supported
    function handleOutImgCP(img, img_a) {
        let data = [];
        const r = 5, g = 6, b = 5, a = 0;
        for (let i = 0; i < img.height * img.width; i++) {
            const color = getPixel_RGBA_int(img_a, i, r, g, b, a);
            data.push(color >> 8, color & 0xFF);
        }

        data = Array.from(deflate_f(new Uint8Array(data),{}));

        let footer = [];

        data = [].concat(
            data,
            Array.from(adler32(1,new Uint8Array(data),data.length,0))  
        );

        data = binaryInvertArray(data);
        data = binarySwapArray(data,5,3);

        data = [].concat(
            int2BigEndianArray(data.length, 4),
            data
        );

        data = [].concat(
            int2LittleEndianArray(0x100, 4),
            int2BigEndianArray(data.length, 4),
            int2BigEndianArray(img.width, 4),
            int2BigEndianArray(img.height, 2),
            int2BigEndianArray(0x10, 2),
            int2LittleEndianArray(1, 4),
            data
        );

        data = [].concat(
            int2BigEndianArray(1, 4),
            int2BigEndianArray(data.length, 4),
            new Array(0x8).fill(0),
            int2BigEndianArray(footer.length, 4),
            new Array(0x70).fill(0),
            data
        );

        let header2 = str2charCodeArray("CP0100Cy875",16);

        data = [].concat(
            new Array(2).fill(0),
            header2,
            int2BigEndianArray(header2.length + data.length + footer.length + 4, 4),
            data
        );

        let header1 = str2charCodeArray("USBPower\x7D\0\x10\0\x10\0");

        header2 = new Array(7).fill(0);

        let size = header1.length + header2.length + data.length + footer.length + 9;
        let sizebytes = int2BigEndianArray(size, 4);

        header1 = [].concat(
            header1,
            (sizebytes[3]+0x41)%0x100,
            1,
            sizebytes,
            (sizebytes[3]+0xB8)%0x100,
        );

        header1 = binaryInvertArray(header1);
        let header = [].concat(
            header1,
            header2
        );

        header = [].concat(
            header,
            sizebytes[2] + sizebytes[3] + 0xAB,
            sizebytes[3] + 0x98,
        );

        data = [].concat(
            header,
            data,
            footer
        );

        let name = ""; //lida com o nome
        let calcName = "";
        name = global_inFileName;
        const iname = name.lastIndexOf('.');
        if (iname >= 0) name = name.substring(0, iname);
        name = name.substring(0, 8);
        calcName = name;

        return [data, calcName];
    }

    function handleOutImg(img) {
        const canvas = document.getElementById('outImgCanvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const context = canvas.getContext('2d', { willReadFrequently: true });
        context.drawImage(img, 0, 0);
        const imgData = context.getImageData(0, 0, img.width, img.height);
        const imgBuffer = imgData.data.buffer;  // ArrayBuffer
        const img_a = new Uint8Array(imgBuffer);

        let r_array = [[], ""];
        r_array = handleOutImgCP(img, img_a);
        let data = r_array[0];
        let calcName = r_array[1];

        let extension = format;
        let i = extension.indexOf(".");
        if(i>=0) {
          extension = extension.slice(i + 1, extension.length);
        }
        let fileName = calcName
        if (extension.length > 0) fileName += "." + extension;

        addBlobFileLink(data, `${fileName}`, document.getElementById("fileList"));

        setButtonState('btnClear', true);

        if (isBatchProcessing) {
            setTimeout(processNext(), 100);
        }
    }


    function int2BigEndianArray(v, n) {
        return int2LittleEndianArray(v, n).reverse();
    }

    function int2LittleEndianArray(v, n) {
        const array = [];
        for (let i = 0; i < n; i++) {
            array.push(v & 0xff);
            v >>= 8;
        }
        return array;
    }

    function str2charCodeArray(str, n=0) {
        let array = [];
        let l = str.length; 
        if (n <= 0) n = l;
        for (let i = 0; i < l; i++)
            array.push(str.charCodeAt(i));
        for (let i = 0; i < n - l; i++)
            array.push(0);
        return array;
    }

    function binaryInvertArray(arr) {
        arr = new Uint8Array(arr);
        for(let i = 0; i < arr.length; i++)
            arr[i] = ~arr[i];
        return Array.from(arr);
    }

    function binarySwapArray(arr,n1,n2) {
        let mask1 = (1 << n1) - 1;
        let mask2 = ((1 << n2) - 1) << n1;
        for(let i = 0; i < arr.length; i++)
            arr[i] = ((arr[i]&mask1)<<n2)|((arr[i]&mask2)>>n1);
        return arr;
    }

    function addBlobFileLink(data, name, parent) {
        let index = parent.children.length + 1;
        let ext = name.split('.').pop();
        let seqName = String(index).padStart(3, '0') + "." + ext;

         let readable_data = "";
        if(typeof(data)=="string") {
        readable_data = data;
        data = str2charCodeArray(data)
        }
        let uint8_data = new Uint8Array(data);
        const li = document.createElement("li");
        const p = document.createElement("span");
        const a = document.createElement("a");
        a.href = window.URL.createObjectURL((new Blob([uint8_data], {type: 'application/octet-stream'})));
        a.dataset.org = name;      // Nome original
        a.dataset.seq = seqName;
        let currentName = document.getElementById("btnToggle").classList.contains("active") ? seqName : name;
        a.download = currentName;
        a.innerText = currentName;
        p.appendChild(a);
        const s = document.createElement("small");
        const i = document.createElement("i");
        i.innerText = " " + (Math.round(data.length / 100) / 10) + " KB";
        s.appendChild(i);
        p.appendChild(s);
        if (readable_data.length > 0) {
          $('#srcFrame').show();
          var el = $('#source8xpcontainer code');
          el.text(readable_data);
          el.html(el.html().replace(/\n/g,'<br/>'));
          el.css('font-size', '11px');
          hljs.highlightBlock(el[0]);
          var lines = el.html().split('<br>');
          lines.forEach(function(a,b) { lines[b] = '<span class="hljs-comment line-number" data-line="'+(b+1)+'"></span>' + a });
          el.html(lines.join('<br>'));
        }
        li.appendChild(p);
        parent.appendChild(li);
        setButtonState('btnToggle', true);
    }

    if (!(window.File && window.FileReader && window.FileList && window.Blob)) {
        alert("Reading files not supported by this browser");
    } else {
        window.handleInFile = handleInFile;
    }
</script>

<script src='./utils/jszip.min.js'></script>

<script>
    let fileQueue = [];
    let isBatchProcessing = false; // Para saber se estamos no ciclo automático

    function processNext() {
        // Atualiza visualmente a lista (opcional: remove o que já foi)
        renderQueue(); 

        if (fileQueue.length > 0) {
            // Retira o primeiro ficheiro da fila e processa
            let nextFile = fileQueue.shift(); 
            handleInFile(nextFile);
        } else {
            // Fila vazia, processo concluído
            isBatchProcessing = false;
            setButtonState('btnConvert',false);
            setButtonState('btnClearInput', false);
            setButtonState('btnzip', true);
        }
    }

    // Função auxiliar para atualizar o HTML da lista
    function renderQueue() {
        const list = document.getElementById("queueList");
        list.innerHTML = "";
        fileQueue.forEach(f => {
            let li = document.createElement("li");
            li.textContent = f.name;
            list.appendChild(li);
        });
    }

    function addToQueue(files) {
        const list = document.getElementById("queueList");
        
        for (let i = 0; i < files.length; i++) {
            fileQueue.push(files[i]);
            
            // Adicionar visualmente à lista HTML
            let li = document.createElement("li");
            li.textContent = files[i].name;
            list.appendChild(li);
        }

        if (fileQueue.length > 0) {
            setButtonState('btnConvert',true);
            setButtonState('btnClearInput', true);
        }
    }

    // Função para mudar o estado (True/False)
    function setButtonState(btnId, isActive) {
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.disabled = !isActive;
            if (isActive) {
                btn.classList.add("btn-ready");
            } else {
                btn.classList.remove("btn-ready");
            }
        }
    }

    function clearOutput() {
        document.getElementById("fileList").innerHTML = "";
        setButtonState('btnClear', false);
        setButtonState('btnzip', false);
        setButtonState('btnToggle', false); // <--- Adicionar esta linha
        document.getElementById("btnToggle").classList.remove("active"); // Reset estado
        document.getElementById("btnToggle").innerText = "Alternar Nome/Num"; // Reset texto
    }
    
    function startProcessing() {
        if (fileQueue.length === 0) return;
        
        isBatchProcessing = true;
        setButtonState('btnConvert',false);
        setButtonState('btnClearInput', false);
        processNext();
    }

    async function downloadZip() {
        const zip = new JSZip();
        const links = document.querySelectorAll("#fileList a");

        if (links.length === 0) {
            alert("A lista está vazia.");
            return;
        }

        const promises = [];

        // Percorre cada link de download gerado
        links.forEach(link => {
            const url = link.href;
            const filename = link.download;
            
            // Faz o fetch do conteúdo do Blob URL e adiciona ao ZIP
            promises.push(
                fetch(url)
                .then(res => res.blob())
                .then(blob => {
                    zip.file(filename, blob);
                })
            );
        });

        // Aguarda que todos os ficheiros sejam processados
        await Promise.all(promises);

        // Gera e descarrega o ZIP
        zip.generateAsync({type: "blob"}).then(function(content) {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(content);
            a.download = "imagens.zip";
            a.click();
        });
    }

    function clearInputQueue() {
        fileQueue = [];
        renderQueue();
        setButtonState('btnConvert', false);
        setButtonState('btnClearInput', false);
    }

    function toggleNames() {
    const btn = document.getElementById("btnToggle");
    const isSeq = btn.classList.toggle("active"); // Usa uma classe para saber o estado
    
    const links = document.querySelectorAll("#fileList a");
    
    links.forEach(a => {
        if (isSeq) {
            a.download = a.dataset.seq;
            a.innerText = a.dataset.seq;
        } else {
            a.download = a.dataset.org;
            a.innerText = a.dataset.org;
        }
    });

    btn.innerText = isSeq ? "Modo: Sequencial (001)" : "Modo: Nome Original";
}
    
</script>

<body>
<br>
<div class="bootstrap"><div class="file" style="text-align: center; margin: auto; display:none">
<div style="margin-bottom: 15px;">
    <details>
        <summary style="cursor: pointer; color: #555; font-weight: bold;">Definições Avançadas</summary>
        
        <div style="border: 1px solid #ddd; padding: 10px; margin-top: 5px; border-radius: 5px; background: #f9f9f9;">
            <label>Largura: <input id="widthInput" type="number" value="384" style="width: 50px;"></label>
            × 
            <label>Altura: <input id="heightInput" type="number" value="192" style="width: 50px;"></label>
            <br><br>
            
            <label>Cores máx: <input id="colorInput" type="number" value="65536" style="width: 70px;"></label>
            <br><br>

            <label><input id="fitInput" type="checkbox"checked> Esticar se menor</label><br>
            <label><input id="ratioInput" type="checkbox" checked> Manter proporção</label>
        </div>
    </details>
</div></div></div>
<br>
<div id="alertas" class="rounded_div">
    <p>
        <b style="display: block; color: #d30000; font-size: x-large; margin-bottom: 5px;">Alertas</b>
        <span style="display: block; line-height: 1.6; margin-bottom: 10px;">
            Os ficheiros de saída não podem ter nomes com mais de 8 caracteres (o programa trunca automaticamente)<br>
            Os ficheiros de saída não podem ter nomes iguais, usar botão Alterar Nome/Num caso necessário<br>
            A Casio lê por ordem ASCII, exemplo de ordem: 1, 10, 11, ..., 19, 2, 20, ...<br>
            É aconcelhável utilizar o botão Alterar Nome/Num para evitar os dois problemas acima
        </span>
    </p>
</div>
<br>
<div id="mainContent">
    <div id="inFrame" class="rounded_div half_div">
        <br>
        <p><b>Source images:</b></p>
        <img id="inImg" alt="" src="" style="display:none;"/>
        <div id="inFile" class="file">
                <input type="file" id="fileElem" multiple accept="image/*" onchange="addToQueue(this.files); this.value='';">
                <label class="button" for="fileElem">Adicionar Ficheiros</label>

                <input type="file" id="folderElem" webkitdirectory multiple onchange="addToQueue(this.files); this.value='';">
                <label class="button" for="folderElem">Adicionar Pasta</label>

                <br><br>
                <button type="button" id="btnConvert" class="button" onclick="startProcessing()" disabled>Converter Lista</button>
                <button type="button" id="btnClearInput" class="button" onclick="clearInputQueue()" disabled>Limpar Fila</button>
                <br><br>

                <strong>Fila de espera:</strong>
                <ul id="queueList"></ul>
        </div>
    </div>
    <div id="outFrame" class="rounded_div half_div">
        <br>
        <p><b>Converted images:</b></p>
        <div id="outFile" class="file">
            <button type="button" id="btnzip" class="button" onclick="downloadZip()" disabled>Download Tudo (ZIP)</button>
            <button type="button" id="btnToggle" class="button" onclick="toggleNames()" disabled>Alternar Nome/Num</button>
            <button type="button" id="btnClear" class="button" onclick="clearOutput()" disabled>Limpar Lista</button>
            <ul id="fileList"></ul>
        </div>
    </div>
    <canvas id="inImgCanvas" style="display:none"></canvas>
    <canvas id="outImgCanvas" style="display:none"></canvas>
    </div>

</div>
</body>
</html>

